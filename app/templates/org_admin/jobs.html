{% extends 'base.html' %}

{% block title %}Jobs - Organization Dashboard{% endblock %}

{% block extra_css %}
<style>
body {
    margin: 0;
    padding: 0;
}

.actions-cell {
    display: flex;
    align-items: center;
    gap: 8px;
}

.copy-url-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: var(--primary);
    font-size: 18px;
    transition: all 0.2s ease;
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    height: 34px;
    width: 34px;
}

.copy-url-btn svg {
    transition: all 0.2s ease;
}

.copy-url-btn:hover {
    color: var(--primary-dark);
    background-color: rgba(105, 108, 255, 0.1);
}

.copy-url-btn:hover svg {
    transform: scale(1.1);
}

.copy-url-btn.copied {
    color: var(--success);
}

.copy-tooltip {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.copy-tooltip.show {
    opacity: 1;
}

.btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
    border: none;
    background: none;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
    text-decoration: none;
    height: 34px;
    width: 34px;
}

.btn-edit {
    color: var(--secondary, #6c757d);
}

.btn-edit:hover {
    background-color: rgba(108, 117, 125, 0.1);
    color: var(--secondary-dark, #5a6268);
}

.btn-edit svg {
    transition: transform 0.2s ease;
}

.btn-edit:hover svg {
    transform: scale(1.1);
}

.search-input {
    width: 100%;
    max-width: 320px;
    padding: var(--spacing-3);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius-md);
    font-size: var(--font-size-base);
    background-color: #ffffff;
    color: #333333;
}

.search-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(105, 108, 255, 0.1);
    background-color: #ffffff;
}

.search-input::placeholder {
    color: #999999;
}

.no-results {
    text-align: center;
    padding: var(--spacing-6) 0;
    color: var(--text-secondary);
    display: none;
}

.table-controls {
    display: flex;
    justify-content: flex-end;
    padding: 0 var(--spacing-4) var(--spacing-3);
}

.table-pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-3) var(--spacing-4);
    background: var(--surface-color, #ffffff);
    border-top: 1px solid var(--border-light);
    gap: var(--spacing-3);
    flex-wrap: wrap;
}

.pagination-info {
    font-size: 13px;
    color: var(--text-secondary);
}

.pagination-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.pagination-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 12px;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--border-light);
    background: #ffffff;
    color: var(--text-primary);
    font-size: 13px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
}

.pagination-button:hover {
    border-color: var(--primary);
    color: var(--primary);
    box-shadow: 0 2px 6px rgba(105, 108, 255, 0.15);
}

.pagination-button--active {
    background: var(--primary);
    color: #ffffff;
    border-color: var(--primary);
}

.pagination-button--disabled {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border-color: var(--border-light);
    cursor: not-allowed;
    pointer-events: none;
}

.sortable-header {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 18px;
}

.sortable-header .sort-icon {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    color: var(--text-secondary);
    transition: color 0.2s ease;
}

.sortable-header:hover .sort-icon,
.sortable-header .sort-icon.active {
    color: var(--primary);
}
</style>
{% endblock %}

{% block content %}
{% from 'org_admin/_layout.html' import admin_layout %}
{% call admin_layout('jobs', current_user) %}
    <div class="page-header">
        <div class="page-header-content">
            <div>
                <h1 class="page-title">Jobs</h1>
                <p class="page-subtitle">Manage your job postings</p>
            </div>
            <div class="page-actions">
                <a href="{{ url_for('org_admin.new_job') }}" class="btn btn-primary btn-create">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                    New Job
                </a>
            </div>
        </div>
    </div>
    
    {% if jobs %}
    <div class="table-container">
        <div class="table-controls">
            <input type="text" id="jobSearch" class="search-input" placeholder="ðŸ” Search jobs by title...">
        </div>
        <table class="table" id="jobsTable">
            <thead>
                <tr>
                    <th class="sortable-header" data-column="title">
                        Job Title <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="sortable-header" data-column="status">
                        Status <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="sortable-header" data-column="date">
                        Publish Date <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="sortable-header" data-column="applicants">
                        Applicants <span class="sort-icon">â‡…</span>
                    </th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="jobsTableBody">
                {% for job in jobs %}
                <tr 
                    data-title="{{ job.title|lower }}"
                    data-status="{{ job.status|lower }}"
                    data-applicants="{{ job.application_count }}"
                    data-date="{{ job.published_at.strftime('%Y%m%d') if job.published_at else '' }}"
                >
                    <td data-label="Job Title"><strong>{{ job.title }}</strong></td>
                    <td data-label="Status">
                        <span class="status-badge status-{{ job.status }}">{{ job.status.capitalize() }}</span>
                    </td>
                    <td data-label="Publish Date">{{ job.published_at.strftime('%d-%m-%Y') if job.published_at else 'Not published' }}</td>
                    <td data-label="Applicants">
                        <a href="{{ url_for('org_admin.applications', job_id=job.id) }}" class="badge badge-primary" title="View {{ job.application_count }} application{{ 's' if job.application_count != 1 else '' }}">
                            {{ job.application_count }}
                        </a>
                    </td>
                    <td data-label="Actions">
                        <div class="actions-cell">
                            <button type="button" class="copy-url-btn" data-url="{{ url_for('public.job_detail', org_slug=job.organization.slug, job_slug=job.public_url_slug, _external=True) }}" title="Copy Job URL">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                </svg>
                                <span class="copy-tooltip">Copy URL</span>
                            </button>
                            <a href="{{ url_for('org_admin.edit_job', job_id=job.id) }}" class="btn-icon btn-edit" title="Edit Job">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if jobs_stats.total > 0 %}
        <div id="jobsPagination" class="table-pagination">
            <span class="pagination-info">
                Showing {{ jobs_stats.start_index }} â€“ {{ jobs_stats.end_index }} of {{ jobs_stats.total }} jobs
            </span>
            <div class="pagination-controls">
                {% if jobs_pagination.has_prev %}
                <a class="pagination-button" href="{{ url_for('org_admin.jobs', page=jobs_pagination.prev_num) }}">Previous</a>
                {% else %}
                <span class="pagination-button pagination-button--disabled">Previous</span>
                {% endif %}

                {% for page_num in jobs_pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <a class="pagination-button {% if page_num == jobs_pagination.page %}pagination-button--active{% endif %}" href="{{ url_for('org_admin.jobs', page=page_num) }}">{{ page_num }}</a>
                    {% else %}
                        <span class="pagination-button pagination-button--disabled">&hellip;</span>
                    {% endif %}
                {% endfor %}

                {% if jobs_pagination.has_next %}
                <a class="pagination-button" href="{{ url_for('org_admin.jobs', page=jobs_pagination.next_num) }}">Next</a>
                {% else %}
                <span class="pagination-button pagination-button--disabled">Next</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
        <div id="jobsNoResults" class="no-results">
            <p>No jobs found matching your search.</p>
        </div>
    </div>
    {% else %}
    <div class="table-container">
        <div class="text-center" style="padding: var(--spacing-8);">
            <p class="text-muted">No jobs found. <a href="{{ url_for('org_admin.new_job') }}">Create your first job</a></p>
        </div>
    </div>
    {% endif %}
{% endcall %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Copy URL script loaded');
    const copyButtons = document.querySelectorAll('.copy-url-btn');
    console.log('Found ' + copyButtons.length + ' copy buttons');
    
    copyButtons.forEach(function(button) {
        // Add click event listener
        button.addEventListener('click', function(e) {
            console.log('Copy button clicked!');
            e.preventDefault();
            e.stopPropagation();
            
            const url = this.getAttribute('data-url');
            console.log('URL to copy:', url);
            const tooltip = this.querySelector('.copy-tooltip');
            
            if (!url) {
                console.error('No URL found in data-url attribute');
                alert('Error: No URL to copy');
                return;
            }
            
            if (!tooltip) {
                console.error('Tooltip element not found');
                return;
            }
            
            const originalText = tooltip.textContent;
            
            // Try to copy using the most reliable method
            copyToClipboard(url, button, tooltip, originalText);
        });
        
        // Add hover effects
        button.addEventListener('mouseenter', function() {
            const tooltip = this.querySelector('.copy-tooltip');
            if (tooltip && tooltip.textContent === 'Copy URL') {
                tooltip.classList.add('show');
            }
        });
        
        button.addEventListener('mouseleave', function() {
            const tooltip = this.querySelector('.copy-tooltip');
            if (tooltip && tooltip.textContent === 'Copy URL') {
                tooltip.classList.remove('show');
            }
        });
    });

    const jobSearchInput = document.getElementById('jobSearch');
    const jobsTableBody = document.getElementById('jobsTableBody');
    const jobsNoResults = document.getElementById('jobsNoResults');
    const jobsTable = document.getElementById('jobsTable');
    const jobsPagination = document.getElementById('jobsPagination');

    if (jobsTableBody) {
        Array.from(jobsTableBody.querySelectorAll('tr')).forEach((row, index) => {
            row.setAttribute('data-original-index', index);
        });
    }

    if (jobSearchInput && jobsTableBody) {
        jobSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const rows = jobsTableBody.querySelectorAll('tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const title = row.getAttribute('data-title') || '';
                const matches = title.includes(searchTerm);

                if (!searchTerm || matches) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            if (jobsNoResults) {
                jobsNoResults.style.display = visibleCount === 0 && searchTerm ? 'block' : 'none';
            }

            if (jobsPagination) {
                jobsPagination.style.display = visibleCount === 0 ? 'none' : 'flex';
            }
        });
    }

    if (jobsTable) {
        const sortState = { column: null, direction: 'none' };
        const headers = jobsTable.querySelectorAll('.sortable-header');

        const updateIcons = (activeHeader, direction) => {
            headers.forEach(header => {
                const icon = header.querySelector('.sort-icon');
                if (!icon) {
                    return;
                }

                if (header === activeHeader) {
                    if (direction === 'none') {
                        icon.classList.remove('active');
                        icon.textContent = 'â‡…';
                    } else {
                        icon.classList.add('active');
                        icon.textContent = direction === 'asc' ? 'â†‘' : 'â†“';
                    }
                } else {
                    icon.classList.remove('active');
                    icon.textContent = 'â‡…';
                }
            });
        };

        const compareValues = (a, b, column, direction) => {
            let aValue;
            let bValue;

            switch (column) {
                case 'title':
                    aValue = a.getAttribute('data-title') || '';
                    bValue = b.getAttribute('data-title') || '';
                    return direction === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                case 'status':
                    aValue = a.getAttribute('data-status') || '';
                    bValue = b.getAttribute('data-status') || '';
                    return direction === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                case 'date':
                    aValue = parseInt(a.getAttribute('data-date') || '0', 10);
                    bValue = parseInt(b.getAttribute('data-date') || '0', 10);
                    return direction === 'asc' ? aValue - bValue : bValue - aValue;
                case 'applicants':
                    aValue = parseInt(a.getAttribute('data-applicants') || '0', 10);
                    bValue = parseInt(b.getAttribute('data-applicants') || '0', 10);
                    return direction === 'asc' ? aValue - bValue : bValue - aValue;
                default:
                    return 0;
            }
        };

        headers.forEach(header => {
            header.addEventListener('click', () => {
                const column = header.getAttribute('data-column');
                if (!column) {
                    return;
                }

                let direction = 'asc';
                if (sortState.column === column) {
                    direction = sortState.direction === 'asc' ? 'desc' : sortState.direction === 'desc' ? 'none' : 'asc';
                }

                sortState.column = direction === 'none' ? null : column;
                sortState.direction = direction;

                updateIcons(header, direction);

                const rows = Array.from(jobsTableBody.querySelectorAll('tr'));

                if (direction === 'none') {
                    rows.sort((a, b) => parseInt(a.getAttribute('data-original-index'), 10) - parseInt(b.getAttribute('data-original-index'), 10));
                } else {
                    rows.sort((a, b) => compareValues(a, b, column, direction));
                }

                rows.forEach(row => jobsTableBody.appendChild(row));
            });
        });
    }
});

function copyToClipboard(url, button, tooltip, originalText) {
    console.log('Attempting to copy:', url);
    // Method 1: Try modern Clipboard API
    if (navigator.clipboard && window.isSecureContext) {
        console.log('Using Clipboard API');
        navigator.clipboard.writeText(url)
            .then(function() {
                console.log('Clipboard API success!');
                showSuccess(button, tooltip, originalText);
            })
            .catch(function(err) {
                console.log('Clipboard API failed, trying fallback...', err);
                fallbackCopy(url, button, tooltip, originalText);
            });
    } else {
        console.log('Clipboard API not available, using fallback');
        // Use fallback method immediately
        fallbackCopy(url, button, tooltip, originalText);
    }
}

function fallbackCopy(url, button, tooltip, originalText) {
    console.log('Using fallback copy method');
    // Create a temporary textarea
    const textArea = document.createElement('textarea');
    textArea.value = url;
    
    // Make it invisible and non-interactive
    textArea.style.position = 'fixed';
    textArea.style.top = '0';
    textArea.style.left = '0';
    textArea.style.width = '2em';
    textArea.style.height = '2em';
    textArea.style.padding = '0';
    textArea.style.border = 'none';
    textArea.style.outline = 'none';
    textArea.style.boxShadow = 'none';
    textArea.style.background = 'transparent';
    textArea.setAttribute('readonly', '');
    
    document.body.appendChild(textArea);
    
    // Select and copy
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        console.log('execCommand result:', successful);
        if (successful) {
            showSuccess(button, tooltip, originalText);
        } else {
            showError(url);
        }
    } catch (err) {
        console.error('Copy failed:', err);
        showError(url);
    } finally {
        document.body.removeChild(textArea);
    }
}

function showSuccess(button, tooltip, originalText) {
    console.log('Showing success feedback');
    button.classList.add('copied');
    tooltip.textContent = 'Copied!';
    tooltip.classList.add('show');
    
    setTimeout(function() {
        button.classList.remove('copied');
        tooltip.textContent = originalText;
        // Don't remove 'show' class if user is still hovering
    }, 2000);
}

function showError(url) {
    alert('Could not copy automatically. Please copy this URL manually:\n\n' + url);
}
</script>
{% endblock %}

