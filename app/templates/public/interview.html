{% extends 'base.html' %}

{% block title %}Interview{% endblock %}

{% block extra_css %}
<style>
    body {
        background: #f5f5f5;
    }
    
    .interview-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 0 20px;
    }
    
    .interview-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
    }
    
    .progress-bar {
        background: #e0e0e0;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .progress-fill {
        background: #4CAF50;
        height: 100%;
        transition: width 0.3s;
    }
    
    .progress-text {
        text-align: center;
        color: #666;
        margin-bottom: 10px;
    }
    
    .chat-container {
        min-height: 400px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background: #fafafa;
        overflow-y: auto;
        max-height: 500px;
    }
    
    .message {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 8px;
        max-width: 80%;
    }
    
    .message-ai {
        background: #e3f2fd;
        margin-right: auto;
    }
    
    .message-user {
        background: #c8e6c9;
        margin-left: auto;
    }
    
    .message-sender {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 12px;
        color: #666;
    }
    
    .controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .recording {
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% {background-color: #f44336;}
        50% {background-color: #e57373;}
    }
    
    .status-text {
        text-align: center;
        padding: 10px;
        margin-bottom: 20px;
        font-weight: 600;
    }
    
    #recordBtn {
        font-size: 18px;
        padding: 15px 30px;
    }
    
    .info-box {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .timer-display {
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        color: #f44336;
        margin: 10px 0;
        min-height: 30px;
    }
    
    .timer-display.active {
        color: #f44336;
    }
</style>
{% endblock %}

{% block content %}
<div class="interview-container">
    <div class="interview-card">
        <h2 style="text-align: center; margin-bottom: 30px;">Pre-Screening Interview</h2>
        
        <div class="info-box">
            <strong>Instructions:</strong> The AI interviewer will ask you questions about the position. Click "Start Recording" to answer each question with your voice. Speak clearly and take your time to provide thoughtful responses.
        </div>
        
        <div class="progress-text" id="progressText">Initializing interview...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="message message-ai">
                <div class="message-sender">AI Interviewer</div>
                <div>Welcome! Please wait while we prepare your interview questions...</div>
            </div>
        </div>
        
        <div class="status-text" id="statusText">Connecting...</div>
        
        <div class="timer-display" id="timerDisplay" style="display: none;"></div>
        
        <div class="controls">
            <button id="recordBtn" class="btn" disabled>Start Recording</button>
            <button id="stopBtn" class="btn btn-danger" style="display: none;">Stop & Submit Answer</button>
            <button id="skipBtn" class="btn btn-secondary" disabled>Skip Question</button>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const socket = io('/interview');
const applicationId = {{ application.id }};
let mediaRecorder;
let audioChunks = [];
let currentQuestion = null;
let totalQuestions = 0;
let currentQuestionNumber = 0;
let recordingStartTime = null;
let timerInterval = null;
let skipInProgress = false;

// Connect to WebSocket
socket.on('connect', () => {
    console.log('Connected to server');
    updateStatus('Connected! Starting interview...');
    socket.emit('start_interview', {application_id: applicationId});
});

socket.on('question', (data) => {
    currentQuestion = data;
    totalQuestions = data.total_questions;
    currentQuestionNumber = data.question_number;
    
    // Update progress
    const progress = (currentQuestionNumber / totalQuestions) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressText').textContent = `Question ${currentQuestionNumber} of ${totalQuestions}`;
    
    // Add question to chat
    addMessage('AI Interviewer', data.text, 'ai');
    
    // Enable recording (speech will play automatically when received)
    document.getElementById('recordBtn').disabled = false;
    document.getElementById('recordBtn').style.display = 'inline-block';
    document.getElementById('skipBtn').disabled = false;
    skipInProgress = false;
    updateStatus('Listening to question...');
});

socket.on('speech_generated', (data) => {
    // Play the natural-sounding speech audio
    playSpeechAudio(data.audio_data);
});

socket.on('transcript_received', (data) => {
    // Update the user message with the actual transcript
    if (data.transcript && data.transcript !== "[Transcription failed]") {
        // Find the last user message and update it
        const chatContainer = document.getElementById('chatContainer');
        const messages = chatContainer.querySelectorAll('.message-user');
        if (messages.length > 0) {
            const lastUserMessage = messages[messages.length - 1];
            const messageContent = lastUserMessage.querySelector('div:last-child');
            if (messageContent && messageContent.textContent === 'Audio answer recorded') {
                messageContent.textContent = data.transcript;
            }
        }
    }
});

socket.on('interview_complete', (data) => {
    // Stop timer if running
    stopTimer();
    
    addMessage('AI Interviewer', data.message, 'ai');
    document.getElementById('progressFill').style.width = '100%';
    document.getElementById('progressText').textContent = 'Interview Complete!';
    document.getElementById('recordBtn').style.display = 'none';
    updateStatus('Thank you for completing the interview!');
    
    setTimeout(() => {
        window.location.href = '/interview/' + applicationId + '/complete';
    }, 3000);
});

socket.on('error', (data) => {
    alert('Error: ' + data.message);
    updateStatus('Error occurred');
});

// Recording functions
document.getElementById('recordBtn').addEventListener('click', startRecording);
document.getElementById('stopBtn').addEventListener('click', stopRecording);
document.getElementById('skipBtn').addEventListener('click', skipQuestion);

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = processRecording;
        
        mediaRecorder.start();
        
        // Start timer
        recordingStartTime = Date.now();
        startTimer();
        
        document.getElementById('recordBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').classList.add('recording');
        document.getElementById('timerDisplay').style.display = 'block';
        document.getElementById('skipBtn').disabled = true;
        updateStatus('ðŸŽ¤ Recording... Click "Stop & Submit Answer" when done');
    } catch (err) {
        alert('Microphone access required. Please allow microphone access and try again.');
        console.error('Error accessing microphone:', err);
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        // Stop timer and calculate duration
        stopTimer();
        const duration = recordingStartTime ? (Date.now() - recordingStartTime) / 1000 : null;
        recordingStartTime = null;
        
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('stopBtn').classList.remove('recording');
        document.getElementById('recordBtn').style.display = 'inline-block';
        document.getElementById('recordBtn').disabled = true;
        document.getElementById('timerDisplay').style.display = 'none';
        document.getElementById('skipBtn').disabled = true;
        updateStatus('Processing your answer...');
        
        // Store duration for use in processRecording
        window.lastRecordingDuration = duration;
    }
}

function processRecording() {
    if (skipInProgress) {
        audioChunks = [];
        return;
    }

    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    const reader = new FileReader();
    
    reader.onloadend = () => {
        const base64Audio = reader.result;
        const duration = window.lastRecordingDuration || null;
        
        // Add user message to chat
        addMessage('You', 'Audio answer recorded', 'user');
        
        // Send answer to server
        socket.emit('answer_submitted', {
            question_id: currentQuestion.question_id,
            audio_data: base64Audio,
            answer_text: '',  // Will be transcribed on server
            duration: duration
        });
        
        updateStatus('Waiting for next question...');
    };
    
    reader.readAsDataURL(audioBlob);
}

function skipQuestion() {
    if (!currentQuestion || skipInProgress) {
        return;
    }
    
    skipInProgress = true;
    stopTimer();
    audioChunks = [];
    window.lastRecordingDuration = null;
    document.getElementById('recordBtn').disabled = true;
    document.getElementById('skipBtn').disabled = true;
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('stopBtn').classList.remove('recording');
    document.getElementById('timerDisplay').style.display = 'none';
    
    addMessage('You', 'Answer skipped by Candidate', 'user');
    updateStatus('Question skipped. Loading next question...');
    
    socket.emit('skip_question', {
        question_id: currentQuestion.question_id
    });
}

function addMessage(sender, text, type) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    messageDiv.innerHTML = `
        <div class="message-sender">${sender}</div>
        <div>${text}</div>
    `;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function updateStatus(text) {
    document.getElementById('statusText').textContent = text;
}

function playSpeechAudio(base64Audio) {
    try {
        // Create audio element - OpenAI TTS returns MP3 format
        const audio = new Audio('data:audio/mpeg;base64,' + base64Audio);
        
        audio.onplay = () => {
            updateStatus('ðŸŽ¤ Question is being read...');
        };
        
        audio.onended = () => {
            updateStatus('Click "Start Recording" to answer');
        };
        
        audio.onerror = (error) => {
            console.error('Error playing audio:', error);
            updateStatus('Click "Start Recording" to answer');
        };
        
        // Play the audio
        audio.play().catch(error => {
            console.error('Error playing audio:', error);
            updateStatus('Click "Start Recording" to answer');
        });
    } catch (error) {
        console.error('Error creating audio element:', error);
        updateStatus('Click "Start Recording" to answer');
    }
}

function startTimer() {
    const timerDisplay = document.getElementById('timerDisplay');
    timerDisplay.classList.add('active');
    
    timerInterval = setInterval(() => {
        if (recordingStartTime) {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }, 100);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    const timerDisplay = document.getElementById('timerDisplay');
    timerDisplay.textContent = '';
    timerDisplay.classList.remove('active');
}
</script>
{% endblock %}

