{% extends 'base.html' %}

{% block title %}Interview{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/public-portal.css') }}">
{% endblock %}

{% block content %}
<div class="public-shell public-shell--interview">
    <div class="interview-card">
        <h2>Pre-screening interview</h2>

        <div class="interview-info">
            <strong>Instructions:</strong> The AI interviewer will guide you through a short conversation. Click ‚ÄúStart recording‚Äù to respond aloud, or switch to typing if needed. Speak clearly and take a breath before each answer.
        </div>

        <div class="interview-progress">
            <div class="interview-progress__text" id="progressText">Initializing interview...</div>
            <div class="interview-progress__bar">
                <div class="interview-progress__fill" id="progressFill" style="width: 0%;"></div>
            </div>
        </div>

        <div class="thinking-banner" id="thinkingContainer">
            <div style="font-size: 1.05rem; font-weight: 600; color: rgba(15, 23, 42, 0.75);">ü§î AI is preparing the question...</div>
            <div class="thinking-banner__dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="chat-timeline" id="chatContainer">
            <div class="chat-message chat-message--ai">
                <div class="chat-message__sender">AI interviewer</div>
                <div>Welcome! Please wait while we prepare your interview questions...</div>
            </div>
        </div>

        <div class="interview-status" id="statusText">Connecting...</div>

        <div class="timer-display" id="timerDisplay" style="display: none;"></div>

        <div class="input-mode-toggle" id="inputModeToggle" style="display: none;">
            <span id="toggleText">Having trouble with recording? <a id="toggleModeBtn">Type your answer instead</a></span>
        </div>

        <div class="control-stack" id="voiceControls">
            <button id="recordBtn" class="btn btn-primary" disabled>Start recording</button>
            <button id="stopBtn" class="btn btn-danger" style="display: none;">Stop &amp; submit answer</button>
            <button id="skipBtn" class="btn btn-secondary" disabled>Skip question</button>
        </div>

        <div class="text-input-panel" id="textInputSection">
            <textarea id="answerTextarea" placeholder="Type your answer here..."></textarea>
            <div class="control-stack">
                <button id="submitTextBtn" class="btn btn-primary">Submit answer</button>
                <button id="skipTextBtn" class="btn btn-secondary">Skip question</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const socket = io('/interview');
const applicationId = {{ application.id }};
let mediaRecorder;
let audioChunks = [];
let currentQuestion = null;
let totalQuestions = 0;
let currentQuestionNumber = 0;
let recordingStartTime = null;
let timerInterval = null;
let skipInProgress = false;
let pendingQuestionData = null;
let questionSpeechReady = false;
let inputMode = 'voice'; // 'voice' or 'text'

// Connect to WebSocket
socket.on('connect', () => {
    console.log('Connected to server');
    updateStatus('Connected! Starting interview...');
    socket.emit('start_interview', {application_id: applicationId});
});

socket.on('question', (data) => {
    console.log('Received question:', data);
    
    // Store question data and show thinking animation
    pendingQuestionData = data;
    questionSpeechReady = false;
    
    // Show thinking animation
    document.getElementById('thinkingContainer').classList.add('active');
    updateStatus('ü§î AI is preparing the question...');
    
    // Update progress
    const progress = (data.question_number / data.total_questions) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressText').textContent = `Question ${data.question_number} of ${data.total_questions}`;
});

socket.on('speech_generated', (data) => {
    // Mark speech as ready
    questionSpeechReady = true;
    
    // If we have pending question data, now display it
    if (pendingQuestionData) {
        displayQuestion(pendingQuestionData, data.audio_data);
        pendingQuestionData = null;
    }
});

socket.on('transcript_received', (data) => {
    // Update the user message with the actual transcript
    if (data.transcript && data.transcript !== "[Transcription failed]") {
        // Find the last user message and update it
        const chatContainer = document.getElementById('chatContainer');
        const messages = chatContainer.querySelectorAll('.message-user');
        if (messages.length > 0) {
            const lastUserMessage = messages[messages.length - 1];
            const messageContent = lastUserMessage.querySelector('div:last-child');
            if (messageContent && messageContent.textContent === 'Audio answer recorded') {
                messageContent.textContent = data.transcript;
            }
        }
    }
});

socket.on('interview_complete', (data) => {
    // Stop timer if running
    stopTimer();
    
    // Hide thinking animation
    document.getElementById('thinkingContainer').classList.remove('active');
    
    addMessage('AI Interviewer', data.message, 'ai');
    document.getElementById('progressFill').style.width = '100%';
    document.getElementById('progressText').textContent = 'Interview Complete!';
    
    // Hide all controls and buttons
    document.getElementById('recordBtn').style.display = 'none';
    document.getElementById('skipBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('voiceControls').style.display = 'none';
    document.getElementById('textInputSection').classList.remove('active');
    document.getElementById('inputModeToggle').style.display = 'none';
    
    updateStatus('Thank you for completing the interview!');
    
    setTimeout(() => {
        window.location.href = '/interview/' + applicationId + '/complete';
    }, 3000);
});

socket.on('error', (data) => {
    console.error('Server error:', data);
    alert('Error: ' + data.message);
    updateStatus('Error occurred: ' + data.message);
});

// Event listeners
document.getElementById('recordBtn').addEventListener('click', startRecording);
document.getElementById('stopBtn').addEventListener('click', stopRecording);
document.getElementById('skipBtn').addEventListener('click', skipQuestion);
document.getElementById('submitTextBtn').addEventListener('click', submitTextAnswer);
document.getElementById('skipTextBtn').addEventListener('click', skipQuestion);
document.getElementById('toggleModeBtn').addEventListener('click', toggleInputMode);

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = processRecording;
        
        mediaRecorder.start();
        
        // Start timer
        recordingStartTime = Date.now();
        startTimer();
        
        document.getElementById('recordBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').classList.add('recording');
        document.getElementById('timerDisplay').style.display = 'block';
        document.getElementById('skipBtn').disabled = true;
        updateStatus('üé§ Recording... Click "Stop & Submit Answer" when done');
    } catch (err) {
        alert('Microphone access required. Please allow microphone access and try again.');
        console.error('Error accessing microphone:', err);
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        // Stop timer and calculate duration
        stopTimer();
        const duration = recordingStartTime ? (Date.now() - recordingStartTime) / 1000 : null;
        recordingStartTime = null;
        
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('stopBtn').classList.remove('recording');
        document.getElementById('recordBtn').style.display = 'inline-block';
        document.getElementById('recordBtn').disabled = true;
        document.getElementById('timerDisplay').style.display = 'none';
        document.getElementById('skipBtn').disabled = true;
        updateStatus('Processing your answer...');
        
        // Store duration for use in processRecording
        window.lastRecordingDuration = duration;
    }
}

function processRecording() {
    if (skipInProgress) {
        audioChunks = [];
        return;
    }

    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    const reader = new FileReader();
    
    reader.onloadend = () => {
        const base64Audio = reader.result;
        const duration = window.lastRecordingDuration || null;
        
        // Add user message to chat
        addMessage('You', 'Audio answer recorded', 'user');
        
        // Send answer to server
        console.log('Submitting answer for question_id:', currentQuestion.question_id);
        socket.emit('answer_submitted', {
            question_id: currentQuestion.question_id,
            audio_data: base64Audio,
            answer_text: '',  // Will be transcribed on server
            duration: duration
        });
        
        updateStatus('Waiting for next question...');
    };
    
    reader.readAsDataURL(audioBlob);
}

function skipQuestion() {
    if (!currentQuestion || skipInProgress) {
        return;
    }
    
    skipInProgress = true;
    stopTimer();
    audioChunks = [];
    window.lastRecordingDuration = null;
    document.getElementById('recordBtn').disabled = true;
    document.getElementById('skipBtn').disabled = true;
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('stopBtn').classList.remove('recording');
    document.getElementById('timerDisplay').style.display = 'none';
    
    addMessage('You', 'Answer skipped by Candidate', 'user');
    updateStatus('Question skipped. Loading next question...');
    
    socket.emit('skip_question', {
        question_id: currentQuestion.question_id
    });
}

function addMessage(sender, text, type) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    messageDiv.innerHTML = `
        <div class="message-sender">${sender}</div>
        <div>${text}</div>
    `;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function updateStatus(text) {
    document.getElementById('statusText').textContent = text;
}

function playSpeechAudio(base64Audio) {
    try {
        // Create audio element - OpenAI TTS returns MP3 format
        const audio = new Audio('data:audio/mpeg;base64,' + base64Audio);
        
        audio.onplay = () => {
            updateStatus('üé§ Question is being read...');
        };
        
        audio.onended = () => {
            updateStatus('Click "Start Recording" to answer');
        };
        
        audio.onerror = (error) => {
            console.error('Error playing audio:', error);
            updateStatus('Click "Start Recording" to answer');
        };
        
        // Play the audio
        audio.play().catch(error => {
            console.error('Error playing audio:', error);
            updateStatus('Click "Start Recording" to answer');
        });
    } catch (error) {
        console.error('Error creating audio element:', error);
        updateStatus('Click "Start Recording" to answer');
    }
}

function startTimer() {
    const timerDisplay = document.getElementById('timerDisplay');
    timerDisplay.classList.add('active');
    
    timerInterval = setInterval(() => {
        if (recordingStartTime) {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }, 100);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    const timerDisplay = document.getElementById('timerDisplay');
    timerDisplay.textContent = '';
    timerDisplay.classList.remove('active');
}

// Display question and play speech
function displayQuestion(questionData, audioData) {
    // Hide thinking animation
    document.getElementById('thinkingContainer').classList.remove('active');
    
    // Store current question data
    currentQuestion = questionData;
    totalQuestions = questionData.total_questions;
    currentQuestionNumber = questionData.question_number;
    
    // Add question to chat
    addMessage('AI Interviewer', questionData.text, 'ai');
    
    // Play speech audio
    playSpeechAudio(audioData);
    
    // Enable controls based on input mode
    if (inputMode === 'voice') {
        document.getElementById('recordBtn').disabled = false;
        document.getElementById('recordBtn').style.display = 'inline-block';
        document.getElementById('skipBtn').disabled = false;
        
        // Hide skip button on last question
        if (currentQuestionNumber === totalQuestions) {
            document.getElementById('skipBtn').style.display = 'none';
        } else {
            document.getElementById('skipBtn').style.display = 'inline-block';
        }
    } else {
        // Text mode
        document.getElementById('answerTextarea').value = '';
        document.getElementById('answerTextarea').disabled = false;
        document.getElementById('submitTextBtn').disabled = false;
        document.getElementById('skipTextBtn').disabled = false;
        
        // Hide skip button on last question
        if (currentQuestionNumber === totalQuestions) {
            document.getElementById('skipTextBtn').style.display = 'none';
        } else {
            document.getElementById('skipTextBtn').style.display = 'inline-block';
        }
    }
    
    // Show toggle option
    document.getElementById('inputModeToggle').style.display = 'block';
    
    skipInProgress = false;
}

// Toggle between voice and text input modes
function toggleInputMode() {
    if (inputMode === 'voice') {
        // Switch to text mode
        inputMode = 'text';
        document.getElementById('voiceControls').style.display = 'none';
        document.getElementById('textInputSection').classList.add('active');
        document.getElementById('toggleText').innerHTML = 'Prefer voice? <a id="toggleModeBtn">Switch to voice recording</a>';
        
        // Reattach event listener to new button
        document.getElementById('toggleModeBtn').addEventListener('click', toggleInputMode);
        
        // Configure skip button visibility for text mode
        if (currentQuestionNumber === totalQuestions) {
            document.getElementById('skipTextBtn').style.display = 'none';
        } else {
            document.getElementById('skipTextBtn').style.display = 'inline-block';
        }
        
        updateStatus('Type your answer in the box below');
    } else {
        // Switch to voice mode
        inputMode = 'voice';
        document.getElementById('voiceControls').style.display = 'flex';
        document.getElementById('textInputSection').classList.remove('active');
        document.getElementById('toggleText').innerHTML = 'Having trouble with recording? <a id="toggleModeBtn">Type your answer instead</a>';
        
        // Reattach event listener to new button
        document.getElementById('toggleModeBtn').addEventListener('click', toggleInputMode);
        
        // Configure skip button visibility for voice mode
        if (currentQuestionNumber === totalQuestions) {
            document.getElementById('skipBtn').style.display = 'none';
        } else {
            document.getElementById('skipBtn').style.display = 'inline-block';
        }
        
        updateStatus('Click "Start Recording" to answer');
    }
}

// Submit text answer
function submitTextAnswer() {
    const answerText = document.getElementById('answerTextarea').value.trim();
    
    if (!answerText) {
        alert('Please type your answer before submitting.');
        return;
    }
    
    if (!currentQuestion) {
        alert('No active question to answer.');
        return;
    }
    
    // Disable controls
    document.getElementById('answerTextarea').disabled = true;
    document.getElementById('submitTextBtn').disabled = true;
    document.getElementById('skipTextBtn').disabled = true;
    
    // Add user message to chat
    addMessage('You', answerText, 'user');
    
    // Send answer to server (no audio, just text)
    socket.emit('answer_submitted', {
        question_id: currentQuestion.question_id,
        audio_data: null,
        answer_text: answerText,
        duration: null
    });
    
    updateStatus('Processing your answer...');
}
</script>
{% endblock %}

