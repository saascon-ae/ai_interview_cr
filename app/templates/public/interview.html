{% extends 'base.html' %}

{% block title %}Interview{% endblock %}

{% block extra_css %}
<style>
    body {
        background: #f5f5f5;
    }
    
    .interview-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 0 20px;
    }
    
    .interview-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
    }
    
    .progress-bar {
        background: #e0e0e0;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .progress-fill {
        background: #4CAF50;
        height: 100%;
        transition: width 0.3s;
    }
    
    .progress-text {
        text-align: center;
        color: #666;
        margin-bottom: 10px;
    }
    
    .chat-container {
        min-height: 400px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background: #fafafa;
        overflow-y: auto;
        max-height: 500px;
    }
    
    .message {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 8px;
        max-width: 80%;
    }
    
    .message-ai {
        background: #e3f2fd;
        margin-right: auto;
    }
    
    .message-user {
        background: #c8e6c9;
        margin-left: auto;
    }
    
    .message-sender {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 12px;
        color: #666;
    }
    
    .controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .recording {
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% {background-color: #f44336;}
        50% {background-color: #e57373;}
    }
    
    .status-text {
        text-align: center;
        padding: 10px;
        margin-bottom: 20px;
        font-weight: 600;
    }
    
    #recordBtn {
        font-size: 18px;
        padding: 15px 30px;
    }
    
    .info-box {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .timer-display {
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        color: #f44336;
        margin: 10px 0;
        min-height: 30px;
    }
    
    .timer-display.active {
        color: #f44336;
    }
    
    /* Thinking Animation */
    .thinking-container {
        display: none;
        text-align: center;
        padding: 20px;
        background: #e3f2fd;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .thinking-container.active {
        display: block;
    }
    
    .thinking-dots {
        display: inline-flex;
        gap: 8px;
        margin-top: 10px;
    }
    
    .thinking-dots span {
        width: 12px;
        height: 12px;
        background: var(--primary, #696cff);
        border-radius: 50%;
        animation: thinking 1.4s infinite;
    }
    
    .thinking-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .thinking-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes thinking {
        0%, 60%, 100% {
            transform: scale(1);
            opacity: 0.5;
        }
        30% {
            transform: scale(1.3);
            opacity: 1;
        }
    }
    
    /* Text Input Section */
    .text-input-section {
        display: none;
        margin-top: 20px;
    }
    
    .text-input-section.active {
        display: block;
    }
    
    .answer-textarea {
        width: 100%;
        min-height: 120px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        font-family: inherit;
        resize: vertical;
        margin-bottom: 15px;
    }
    
    .answer-textarea:focus {
        outline: none;
        border-color: var(--primary, #696cff);
    }
    
    .input-mode-toggle {
        text-align: center;
        margin: 15px 0;
        padding: 10px;
        background: #f0f0f0;
        border-radius: 4px;
    }
    
    .input-mode-toggle a {
        color: var(--primary, #696cff);
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
    }
    
    .input-mode-toggle a:hover {
        text-decoration: underline;
    }
    
    .controls-voice, .controls-text {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="interview-container">
    <div class="interview-card">
        <h2 style="text-align: center; margin-bottom: 30px;">Pre-Screening Interview</h2>
        
        <div class="info-box">
            <strong>Instructions:</strong> The AI interviewer will ask you questions about the position. Click "Start Recording" to answer each question with your voice. Speak clearly and take your time to provide thoughtful responses.
        </div>
        
        <div class="progress-text" id="progressText">Initializing interview...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        
        <!-- Thinking Animation -->
        <div class="thinking-container" id="thinkingContainer">
            <div style="font-size: 18px; font-weight: 600; color: #666;">ðŸ¤” AI is preparing the question...</div>
            <div class="thinking-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="message message-ai">
                <div class="message-sender">AI Interviewer</div>
                <div>Welcome! Please wait while we prepare your interview questions...</div>
            </div>
        </div>
        
        <div class="status-text" id="statusText">Connecting...</div>
        
        <div class="timer-display" id="timerDisplay" style="display: none;"></div>
        
        <!-- Input Mode Toggle -->
        <div class="input-mode-toggle" id="inputModeToggle" style="display: none;">
            <span id="toggleText">Having trouble with recording? <a id="toggleModeBtn">Type your answer instead</a></span>
        </div>
        
        <!-- Voice Controls -->
        <div class="controls controls-voice" id="voiceControls">
            <button id="recordBtn" class="btn" disabled>Start Recording</button>
            <button id="stopBtn" class="btn btn-danger" style="display: none;">Stop & Submit Answer</button>
            <button id="skipBtn" class="btn btn-secondary" disabled>Skip Question</button>
        </div>
        
        <!-- Text Input Section -->
        <div class="text-input-section" id="textInputSection">
            <textarea id="answerTextarea" class="answer-textarea" placeholder="Type your answer here..."></textarea>
            <div class="controls controls-text">
                <button id="submitTextBtn" class="btn btn-primary">Submit Answer</button>
                <button id="skipTextBtn" class="btn btn-secondary">Skip Question</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const socket = io('/interview');
const applicationId = {{ application.id }};
let mediaRecorder;
let audioChunks = [];
let currentQuestion = null;
let totalQuestions = 0;
let currentQuestionNumber = 0;
let recordingStartTime = null;
let timerInterval = null;
let skipInProgress = false;
let pendingQuestionData = null;
let questionSpeechReady = false;
let inputMode = 'voice'; // 'voice' or 'text'

// Connect to WebSocket
socket.on('connect', () => {
    console.log('Connected to server');
    updateStatus('Connected! Starting interview...');
    socket.emit('start_interview', {application_id: applicationId});
});

socket.on('question', (data) => {
    console.log('Received question:', data);
    
    // Store question data and show thinking animation
    pendingQuestionData = data;
    questionSpeechReady = false;
    
    // Show thinking animation
    document.getElementById('thinkingContainer').classList.add('active');
    updateStatus('ðŸ¤” AI is preparing the question...');
    
    // Update progress
    const progress = (data.question_number / data.total_questions) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressText').textContent = `Question ${data.question_number} of ${data.total_questions}`;
});

socket.on('speech_generated', (data) => {
    // Mark speech as ready
    questionSpeechReady = true;
    
    // If we have pending question data, now display it
    if (pendingQuestionData) {
        displayQuestion(pendingQuestionData, data.audio_data);
        pendingQuestionData = null;
    }
});

socket.on('transcript_received', (data) => {
    // Update the user message with the actual transcript
    if (data.transcript && data.transcript !== "[Transcription failed]") {
        // Find the last user message and update it
        const chatContainer = document.getElementById('chatContainer');
        const messages = chatContainer.querySelectorAll('.message-user');
        if (messages.length > 0) {
            const lastUserMessage = messages[messages.length - 1];
            const messageContent = lastUserMessage.querySelector('div:last-child');
            if (messageContent && messageContent.textContent === 'Audio answer recorded') {
                messageContent.textContent = data.transcript;
            }
        }
    }
});

socket.on('interview_complete', (data) => {
    // Stop timer if running
    stopTimer();
    
    // Hide thinking animation
    document.getElementById('thinkingContainer').classList.remove('active');
    
    addMessage('AI Interviewer', data.message, 'ai');
    document.getElementById('progressFill').style.width = '100%';
    document.getElementById('progressText').textContent = 'Interview Complete!';
    
    // Hide all controls and buttons
    document.getElementById('recordBtn').style.display = 'none';
    document.getElementById('skipBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('voiceControls').style.display = 'none';
    document.getElementById('textInputSection').classList.remove('active');
    document.getElementById('inputModeToggle').style.display = 'none';
    
    updateStatus('Thank you for completing the interview!');
    
    setTimeout(() => {
        window.location.href = '/interview/' + applicationId + '/complete';
    }, 3000);
});

socket.on('error', (data) => {
    console.error('Server error:', data);
    alert('Error: ' + data.message);
    updateStatus('Error occurred: ' + data.message);
});

// Event listeners
document.getElementById('recordBtn').addEventListener('click', startRecording);
document.getElementById('stopBtn').addEventListener('click', stopRecording);
document.getElementById('skipBtn').addEventListener('click', skipQuestion);
document.getElementById('submitTextBtn').addEventListener('click', submitTextAnswer);
document.getElementById('skipTextBtn').addEventListener('click', skipQuestion);
document.getElementById('toggleModeBtn').addEventListener('click', toggleInputMode);

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = processRecording;
        
        mediaRecorder.start();
        
        // Start timer
        recordingStartTime = Date.now();
        startTimer();
        
        document.getElementById('recordBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').classList.add('recording');
        document.getElementById('timerDisplay').style.display = 'block';
        document.getElementById('skipBtn').disabled = true;
        updateStatus('ðŸŽ¤ Recording... Click "Stop & Submit Answer" when done');
    } catch (err) {
        alert('Microphone access required. Please allow microphone access and try again.');
        console.error('Error accessing microphone:', err);
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        // Stop timer and calculate duration
        stopTimer();
        const duration = recordingStartTime ? (Date.now() - recordingStartTime) / 1000 : null;
        recordingStartTime = null;
        
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('stopBtn').classList.remove('recording');
        document.getElementById('recordBtn').style.display = 'inline-block';
        document.getElementById('recordBtn').disabled = true;
        document.getElementById('timerDisplay').style.display = 'none';
        document.getElementById('skipBtn').disabled = true;
        updateStatus('Processing your answer...');
        
        // Store duration for use in processRecording
        window.lastRecordingDuration = duration;
    }
}

function processRecording() {
    if (skipInProgress) {
        audioChunks = [];
        return;
    }

    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    const reader = new FileReader();
    
    reader.onloadend = () => {
        const base64Audio = reader.result;
        const duration = window.lastRecordingDuration || null;
        
        // Add user message to chat
        addMessage('You', 'Audio answer recorded', 'user');
        
        // Send answer to server
        console.log('Submitting answer for question_id:', currentQuestion.question_id);
        socket.emit('answer_submitted', {
            question_id: currentQuestion.question_id,
            audio_data: base64Audio,
            answer_text: '',  // Will be transcribed on server
            duration: duration
        });
        
        updateStatus('Waiting for next question...');
    };
    
    reader.readAsDataURL(audioBlob);
}

function skipQuestion() {
    if (!currentQuestion || skipInProgress) {
        return;
    }
    
    skipInProgress = true;
    stopTimer();
    audioChunks = [];
    window.lastRecordingDuration = null;
    document.getElementById('recordBtn').disabled = true;
    document.getElementById('skipBtn').disabled = true;
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('stopBtn').classList.remove('recording');
    document.getElementById('timerDisplay').style.display = 'none';
    
    addMessage('You', 'Answer skipped by Candidate', 'user');
    updateStatus('Question skipped. Loading next question...');
    
    socket.emit('skip_question', {
        question_id: currentQuestion.question_id
    });
}

function addMessage(sender, text, type) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    messageDiv.innerHTML = `
        <div class="message-sender">${sender}</div>
        <div>${text}</div>
    `;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function updateStatus(text) {
    document.getElementById('statusText').textContent = text;
}

function playSpeechAudio(base64Audio) {
    try {
        // Create audio element - OpenAI TTS returns MP3 format
        const audio = new Audio('data:audio/mpeg;base64,' + base64Audio);
        
        audio.onplay = () => {
            updateStatus('ðŸŽ¤ Question is being read...');
        };
        
        audio.onended = () => {
            updateStatus('Click "Start Recording" to answer');
        };
        
        audio.onerror = (error) => {
            console.error('Error playing audio:', error);
            updateStatus('Click "Start Recording" to answer');
        };
        
        // Play the audio
        audio.play().catch(error => {
            console.error('Error playing audio:', error);
            updateStatus('Click "Start Recording" to answer');
        });
    } catch (error) {
        console.error('Error creating audio element:', error);
        updateStatus('Click "Start Recording" to answer');
    }
}

function startTimer() {
    const timerDisplay = document.getElementById('timerDisplay');
    timerDisplay.classList.add('active');
    
    timerInterval = setInterval(() => {
        if (recordingStartTime) {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }, 100);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    const timerDisplay = document.getElementById('timerDisplay');
    timerDisplay.textContent = '';
    timerDisplay.classList.remove('active');
}

// Display question and play speech
function displayQuestion(questionData, audioData) {
    // Hide thinking animation
    document.getElementById('thinkingContainer').classList.remove('active');
    
    // Store current question data
    currentQuestion = questionData;
    totalQuestions = questionData.total_questions;
    currentQuestionNumber = questionData.question_number;
    
    // Add question to chat
    addMessage('AI Interviewer', questionData.text, 'ai');
    
    // Play speech audio
    playSpeechAudio(audioData);
    
    // Enable controls based on input mode
    if (inputMode === 'voice') {
        document.getElementById('recordBtn').disabled = false;
        document.getElementById('recordBtn').style.display = 'inline-block';
        document.getElementById('skipBtn').disabled = false;
        
        // Hide skip button on last question
        if (currentQuestionNumber === totalQuestions) {
            document.getElementById('skipBtn').style.display = 'none';
        } else {
            document.getElementById('skipBtn').style.display = 'inline-block';
        }
    } else {
        // Text mode
        document.getElementById('answerTextarea').value = '';
        document.getElementById('answerTextarea').disabled = false;
        document.getElementById('submitTextBtn').disabled = false;
        document.getElementById('skipTextBtn').disabled = false;
        
        // Hide skip button on last question
        if (currentQuestionNumber === totalQuestions) {
            document.getElementById('skipTextBtn').style.display = 'none';
        } else {
            document.getElementById('skipTextBtn').style.display = 'inline-block';
        }
    }
    
    // Show toggle option
    document.getElementById('inputModeToggle').style.display = 'block';
    
    skipInProgress = false;
}

// Toggle between voice and text input modes
function toggleInputMode() {
    if (inputMode === 'voice') {
        // Switch to text mode
        inputMode = 'text';
        document.getElementById('voiceControls').style.display = 'none';
        document.getElementById('textInputSection').classList.add('active');
        document.getElementById('toggleText').innerHTML = 'Prefer voice? <a id="toggleModeBtn">Switch to voice recording</a>';
        
        // Reattach event listener to new button
        document.getElementById('toggleModeBtn').addEventListener('click', toggleInputMode);
        
        // Configure skip button visibility for text mode
        if (currentQuestionNumber === totalQuestions) {
            document.getElementById('skipTextBtn').style.display = 'none';
        } else {
            document.getElementById('skipTextBtn').style.display = 'inline-block';
        }
        
        updateStatus('Type your answer in the box below');
    } else {
        // Switch to voice mode
        inputMode = 'voice';
        document.getElementById('voiceControls').style.display = 'flex';
        document.getElementById('textInputSection').classList.remove('active');
        document.getElementById('toggleText').innerHTML = 'Having trouble with recording? <a id="toggleModeBtn">Type your answer instead</a>';
        
        // Reattach event listener to new button
        document.getElementById('toggleModeBtn').addEventListener('click', toggleInputMode);
        
        // Configure skip button visibility for voice mode
        if (currentQuestionNumber === totalQuestions) {
            document.getElementById('skipBtn').style.display = 'none';
        } else {
            document.getElementById('skipBtn').style.display = 'inline-block';
        }
        
        updateStatus('Click "Start Recording" to answer');
    }
}

// Submit text answer
function submitTextAnswer() {
    const answerText = document.getElementById('answerTextarea').value.trim();
    
    if (!answerText) {
        alert('Please type your answer before submitting.');
        return;
    }
    
    if (!currentQuestion) {
        alert('No active question to answer.');
        return;
    }
    
    // Disable controls
    document.getElementById('answerTextarea').disabled = true;
    document.getElementById('submitTextBtn').disabled = true;
    document.getElementById('skipTextBtn').disabled = true;
    
    // Add user message to chat
    addMessage('You', answerText, 'user');
    
    // Send answer to server (no audio, just text)
    socket.emit('answer_submitted', {
        question_id: currentQuestion.question_id,
        audio_data: null,
        answer_text: answerText,
        duration: null
    });
    
    updateStatus('Processing your answer...');
}
</script>
{% endblock %}

